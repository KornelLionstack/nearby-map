window.nearby_map=window.nearby_map||{};window.nearby_map_object=window.nearby_map_object||{};window.nearby_origins=window.nearby_origins||{};document.addEventListener("DOMContentLoaded",function(){const buttons=document.querySelectorAll('[class*="proximity_place_"]');const ajaxUrl=typeof ajaxurl!=="undefined"?ajaxurl:typeof cspm_nearby_map!=="undefined"?cspm_nearby_map.ajax_url:"/wp-admin/admin-ajax.php";buttons.forEach(button=>{button.addEventListener("click",function(){const typeLabel=this.dataset.proximityName;const mapId=this.dataset.mapId;const slug=slugify(typeLabel);fetch(ajaxUrl+"?action=get_custom_nearby_locations").then(response=>response.json()).then(locations=>{const filtered=locations.filter(loc=>slugify(loc.type)===slug);if(filtered.length===0){console.warn(`Nincs találat a '${slug}' slug-hoz.`)}displayMarkersOnMap(filtered,mapId)}).catch(err=>console.error("Helyek betöltésekor hiba történt:",err))})});function slugify(text){const accentsMap=new Map([["á","a"],["é","e"],["í","i"],["ó","o"],["ö","o"],["ő","o"],["ú","u"],["ü","u"],["ű","u"],["Á","a"],["É","e"],["Í","i"],["Ó","o"],["Ö","o"],["Ő","o"],["Ú","u"],["Ü","u"],["Ű","u"]]);let slug=text.toLowerCase().split("").map(char=>accentsMap.get(char)||char).join("");return slug.replace(/[\s\-]+/g,"_").replace(/[^a-z0-9_]/g,"").trim()}function displayMarkersOnMap(locations,mapId){const elementId="codespacing_progress_map_"+mapId;const mapElement=document.getElementById(elementId);if(!mapElement)return console.error(`Nem található a térkép elem: ${elementId}`);const lat=parseFloat(mapElement.dataset.lat||47.4555962);const lng=parseFloat(mapElement.dataset.lng||19.0435047);const zoom=parseInt(mapElement.dataset.zoom||13);const map=new google.maps.Map(mapElement,{center:{lat:lat,lng:lng},zoom:zoom,mapTypeId:"roadmap"});window.nearby_map[mapId]=map;window.nearby_map_object[mapId]=map;window.nearby_origins[mapId]=new google.maps.LatLng(lat,lng);const directionsService=new google.maps.DirectionsService;const directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});directionsRenderer.setMap(map);const infoWindow=new google.maps.InfoWindow;const markerBase=typeof cspm_nearby_map!=="undefined"&&cspm_nearby_map.place_markers_file_url?cspm_nearby_map.place_markers_file_url:"";locations.forEach(loc=>{const icon=markerBase?{url:markerBase+slugify(loc.type)+".svg",scaledSize:new google.maps.Size(40,40)}:null;const marker=new google.maps.Marker({position:{lat:loc.lat,lng:loc.lng},map:map,title:loc.name,...icon?{icon:icon}:{}});marker.addListener("click",()=>{directionsRenderer.setMap(map);directionsRenderer.set("directions",null);directionsService.route({origin:window.nearby_origins[mapId],destination:{lat:loc.lat,lng:loc.lng},travelMode:google.maps.TravelMode.DRIVING},(result,status)=>{if(status==="OK"){directionsRenderer.setDirections(result);const leg=result.routes[0].legs[0];const steps=leg.steps.map(step=>`<li>${step.instructions.replace(/<div.*?>|<\/div>/g,"")} - ${step.distance.text}</li>`).join("");const googleMapText=typeof cspm_nearby_map!=="undefined"?cspm_nearby_map.google_map_link_text:"Open On Google Map";const gmapsLink=`https://www.google.com/maps/dir/?api=1&origin=${window.nearby_origins[mapId].lat()},${window.nearby_origins[mapId].lng()}&destination=${loc.lat},${loc.lng}`;infoWindow.setContent(`<strong>${loc.name}</strong><br>`+`${leg.duration.text} (${leg.distance.text})`+`<ol>${steps}</ol>`+`<a href="${gmapsLink}" target="_blank" rel="noopener">${googleMapText}</a>`)}else{infoWindow.setContent("Nincs elérhető útvonal")}infoWindow.open(map,marker)})})})}});
