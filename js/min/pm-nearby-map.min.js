window.nearby_map=window.nearby_map||{},window.nearby_map_object=window.nearby_map_object||{},window.origin=window.origin||{};let customMap,customLocations=[],customMarkers=[];function addCustomMarker(e,o,t,a){if(!customMap)return;const n={lat:parseFloat(e),lng:parseFloat(o)};let s;if(google.maps.marker&&google.maps.marker.AdvancedMarkerElement){const e={map:customMap,position:n,title:t||""},o=getIconByType(a);o&&(e.gmpIcon=o),s=new google.maps.marker.AdvancedMarkerElement(e)}else s=new google.maps.Marker({position:n,map:customMap,title:t||"",icon:getIconByType(a)});return customMarkers.push(s),s}function clearCustomMarkers(){customMarkers.forEach(e=>{"function"==typeof e.setMap?e.setMap(null):e.map=null}),customMarkers=[]}function loadNearbyLocations(e){const o="undefined"!=typeof cspm_nearby_map&&cspm_nearby_map.ajax_url?cspm_nearby_map.ajax_url:"/wp-admin/admin-ajax.php";fetch(o+"?action=get_custom_nearby_locations").then(e=>e.json()).then(o=>{const t=e?o.filter(o=>slugifyType(o.type)===e):o;clearCustomMarkers(),t.forEach(e=>{e.lat&&e.lng&&addCustomMarker(parseFloat(e.lat),parseFloat(e.lng),e.name||"",slugifyType(e.type||""))})}).catch(e=>{console.error("Helyek betöltése sikertelen:",e)})}function slugifyType(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().replace(/[\s-]+/g,"_").replace(/[^a-z0-9_]/g,"").replace(/^_+|_+$/g,"")}function onReady(e){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}function waitForGoogleMaps(e,o=20){"undefined"!=typeof google&&google.maps?e():o>0&&setTimeout(function(){waitForGoogleMaps(e,o-1)},500)}function initCustomNearbyMap(){let e=document.getElementById("map");if(e||(e=document.querySelector('.cspm_map_container div[id^="codespacing_progress_map_"]')),!e)return;const o=new google.maps.Map(e,{center:{lat:47.4979,lng:19.0402},zoom:13});customMap=o;const t="undefined"!=typeof cspm_nearby_map&&cspm_nearby_map.ajax_url?cspm_nearby_map.ajax_url:"/wp-admin/admin-ajax.php";fetch(t+"?action=get_custom_nearby_locations").then(e=>e.json()).then(e=>{console.log("Loaded locations from JSON:",e),customLocations=Array.isArray(e)?e.map(e=>Object.assign({},e,{slug:slugifyType(e.type||"")})):[],renderCustomTypeFilter(customLocations),bindCategoryHover(),customLocations.forEach(e=>{e.lat&&e.lng&&addCustomMarker(e.lat,e.lng,e.name||"Hely",e.slug)})}).catch(e=>console.error("Hiba a helyek betöltésekor:",e))}onReady(function(){waitForGoogleMaps(initCustomNearbyMap)});const typeAliases={bowling:"bowling_alley",bevasarlas_es_kiskereskedelem:"shopping_mall",kozlekedes:"bus_station",egeszsegugyi_letesitmenyek:"hospital",oktatasi_intezmenyek:"school",jszakai_let__klub:"night_club",sport_es_rekreacio:"stadium",ttermek:"restaurant",kulturalis_helyszinek:"museum",kavezok:"cafe"};function getIconByType(e){if("undefined"!=typeof cspm_nearby_map&&cspm_nearby_map.place_markers_file_url){const o=typeAliases[e]||e;return cspm_nearby_map.place_markers_file_url+o+".png"}return null}function getCustomTypesFromJSON(e){const o=new Map;return e.forEach(e=>{e.slug&&e.type&&!o.has(e.slug)&&o.set(e.slug,e.type)}),o}function renderCustomTypeFilter(e){const o=document.querySelector("#cspm-filter");if(!o)return;const t=getCustomTypesFromJSON(e);let a='<select id="custom-type-selector"><option value="">– Összes típus –</option>';t.forEach((e,o)=>{a+=`<option value="${o}">${e}</option>`}),a+="</select>",o.innerHTML=a,document.querySelector("#custom-type-selector").addEventListener("change",function(){loadNearbyLocations(this.value)})}function showFilteredLocations(e){const o=e?customLocations.filter(o=>o.slug===e):customLocations;clearCustomMarkers(),o.forEach(e=>{addCustomMarker(e.lat,e.lng,e.name,e.slug)})}function bindCategoryHover(){document.querySelectorAll(".cspm_nearby_cat_holder").forEach(e=>{const o=slugifyType(e.getAttribute("id")||e.dataset.proximityName||"");e.addEventListener("mouseenter",()=>{loadNearbyLocations(o)}),e.addEventListener("mouseleave",()=>{loadNearbyLocations("")}),e.addEventListener("click",()=>{loadNearbyLocations(o)})})}function cspm_nearby_locations(e,o,t,a,n,s){loadNearbyLocations(slugifyType(o||""))}
